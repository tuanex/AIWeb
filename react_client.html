<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Side</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>
	<div id="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>


    <script type="text/babel">
		const url = "http://vm146.rz.uni-osnabrueck.de/";

        function ChannelList() {
            // React component that shows a channel list
            // content is fetched from the university hub (works only on university network, use VPN)
            //
            const [channels, setChannels] = React.useState([]);

            React.useEffect(() => {
                // Fetch list of channels
                fetch("http://vm146.rz.uni-osnabrueck.de/hub/channels") // university hub
                    .then(response => response.json())
                    .then(data => setChannels(data.channels));
            }, []);  // empty list here means that this effect will run only once (you can add a variable to run it on change)

            return (
				<div>
                    <h2>Channel List</h2>
                    <ul>
                        {channels.map(channel => (
                            <li key={channel.id}>
								<LinkButton channel={channel} channelClick={handleChannelOpen} />
                            </li>
                        ))}
                    </ul>
				</div>
            );
        }

		function Images() {
			return (
				<div>
					<img src="https://picsum.photos/300/200" />
				</div>
			)
		}

		function LinkButton({ channel, channelClick }) {
			return (
				<div onClick={() => {channelClick({channel});} } className="link">
					{channel.name}
				</div>
			);
		}

		function handleChannelOpen({channel}) {

			let new_root = document.querySelector('#new_root');

			// Hide hub
			let root_children = new_root.childNodes;
			root_children.forEach((child) => {
				child.className = "hidden"
			})

			// Show clicked channel
			showChannel(channel={channel});
		}

		function showChannel({channel}) {
			ReactDOM.render(
				<div className="channel">
					<p className="link" onClick={hideChannel}>Click here to go back to the hub.</p>
					<Channel channel={channel} />
					<Buttons />
					<Post channel={channel}/>
				</div>,
				document.querySelector('#new_root')
			);
		}

		function hideChannel() {
			ReactDOM.render(
				<div id="new_root">
					<h1>Chat client: List of channels</h1>
					<Images />
					<ChannelList />
					<Buttons />
				</div>,
				document.querySelector('#new_root')
			); 
		}

		function Channel({ channel }) {

            const [msgs, setMsgs] = React.useState([]);

			//console.log(channel.endpoint.match(/\/[^/]+\/channel.wsgi/g));
			let matches = channel.endpoint.match(/\/[^/]+/g);
			console.log(matches[0].match(/[^/]+/));
			//console.log(channel.endpoint.match(/[^[channel.wsgi]]/));

            React.useEffect(() => {
				let fetchMessages = async () => {
					try {
						let response = await fetch(`http:/${matches[0]}${matches[1]}/messages.json`);
						if (!response.ok) {
							alert("fetching messages returned error");
							return;
						}

						const result = await response.json();
						setMsgs(result);
					} catch (err) {
						try {
						let response = await fetch(`http:/${matches[0]}${matches[1]}/channel/messages.json`);
						if (!response.ok) {
							alert("fetching messages returned error");
							return;
						}

						const result = await response.json();
						setMsgs(result);
						} catch (err) {
							alert(err);
						}
					}
				}

				fetchMessages();
            }, []);  // empty list here means that this effect will run only once (you can add a variable to run it on change)

			return (
				<div>
					<h1>{channel.name}</h1>
					<ul>
						{msgs.map(msg => (
							<Message msg={msg} />
						))}
					</ul>
				</div>
			)
		}

		function Message({msg}) {
			return (
				<div className="message">
					<h2>{msg.sender} <span className="timestamp">{msg.timestamp}</span></h2>
					<p className="content_hide" id={msg.timestamp} onClick={(event) => {
						if (event.target.classList.contains("content_hide")) {
							event.target.classList.remove("content_hide");
						}
						else {
							event.target.classList.add("content_hide")
						}
					}} >{msg.content}</p>
				</div>
			)
		}


		function Buttons() {
			return (
				<div id="buttons">
					<div className="scroll top button" onClick={() => {
						document.body.scrollTop = document.documentElement.scrollTop = 0;
					}}>Scroll to top</div>

					<div className="scroll end button" onClick={() => {
						window.scrollTo(0, document.body.scrollHeight);
					}}>Scroll to end</div>

					<div className="dark_mode button" style={{'top': '5px'}} onClick={() => {
						let html_div = document.querySelector('html');
						if (html_div.classList.contains("dark_mode")) {
							html_div.classList.remove("dark_mode");
						}
						else {
							html_div.classList.add("dark_mode");
						}
						
					}}>
						Dark Mode
					</div>
				</div>
			);
		}

		function Post({channel}) {
			console.log(`endpoint ${channel.authkey}`);
			let sendPost = async (event) => {
				console.log(event.target.parentNode.querySelector('#sender').value);
				console.log(event.target.parentNode.querySelector('#message').value);
				let now = new Date;
				try {
					fetch(channel.endpoint, {
						method: "POST",
						headers: {
							"Authorization": `authkey ${channel.authkey}`
						},

						body: JSON.stringify({
							"sender": ``,
							"content": "Hello",
							"timestamp": `${now.toISOString()}`,
						}),
					});
				}
				catch (err) {
					console.log(err);
				}
			}
			return (
				<div >
					Sender: <input id="sender" /> <br />
					Message: <input id="message" /> <br />
					<div className="button" onClick={(event) => {sendPost(event);}}>Submit</div>
				</div>
			)
		}

		
		ReactDOM.render(
			<div id="new_root">
				<h1>Chat client: List of channels</h1>
				<Images />
				<ChannelList />
				<Buttons />
			</div>,
			document.getElementById('root')); 
		

        // main code: render the ChannelList component, add more components here
	</script>

</body>
</html>
